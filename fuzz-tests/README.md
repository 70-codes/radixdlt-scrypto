# Introduction

This package implements fuzz tests for Radix Engine.
Currently it uses 2 fuzzing engines:
* [AFLplusplus](https://aflplus.plus/)
  It is wrapped by crate: [cargo-afl](https://docs.rs/afl/0.14.1/afl)
* simple-fuzzer
  This is a very simple fuzzer, which is especially useful when developing new fuzz tests.
  It allows to:
  - quickly rebuild a test and perform some simple checks (building AFL takes ages).
  - reproduce a crash (or other problematic case) using provided input file,
    (which might be generated by AFL)

# AFL
* It sets `fuzzing` compilation config by default.
  Be aware that some crates might change behaviour depending on this flag.
  See [secp256k1](https://github.com/rust-bitcoin/rust-secp256k1/#fuzzing), which was using
  this flag before switching to `secp256k1_fuzz`.

  However, at the moment it looks like it is safe to use `fuzzing` config within Radix Engine and
  its dependencies.

* It requires some input data to be provided.

## Installation
One can use convenience script [install_afl.sh](./install_afl.sh) to install `cargo-afl` with the change mentioned above.

## Machine setup
Before starting to fuzz AFL checks machine configuration and requests to adjust some settings if required.
To adjust settings for best performance following command shall be called:
```
cargo afl system-config
```

# Input data
Sample input data shall be placed in `fuzz_input` folder in dedicated subfolder.
`AFL` is able to use the data in the same format.

In order to minimize the test corpus, the data might be prior processed.
Processing method is specific for fuzzing engine.

One can use following command to generate input data (`cargo afl cmin|tmin` are used here)
`./fuzz.sh generate-input [raw|unique|minimize]`
Check `./fuzz.sh help` for more details

# Fuzz targets
Available fuzz targets might be listed with following command:
```
./list-fuzz-targets.sh
```

# Usage

Helper script [fuzz.sh](./fuzz.sh) to unify fuzzing experience accross the fuzzing engines ;)

`./fuzz.sh [FUZZER/COMMAND] [SUBCOMMAND] [COMMAND-ARGS]`

Currently it allows to build and run fuzz tests using some default configuration.
Check: `./fuzz.sh help` for more details.

For more sophisticated use cases `cargo fuzz` or `cargo afl` shall be used directly.
Check:
`cargo +nightly fuzz --help`
or
`cargo afl --help`

## Examples
* Generate input
  - Generate input
    ```
    ./fuzz.sh generate-input raw|unique|minimize
    ```
  - Generate unique input
* AFL
  - Run 2 AFL sessions (`main` and `slave`) and let it automatically resume if the same session was already running
    (each command in separate console)
    ```
    AFL_AUTORESUME=1 cargo afl fuzz -i fuzz_input/transaction -o afl/transaction -M main -T transaction  target-afl/release/transaction
    ```
    ```
    AFL_AUTORESUME=1 cargo afl fuzz -i fuzz_input/transaction -o afl/transaction -S slave -T transaction  target-afl/release/transaction
    ```
  - Check status of the AFL fuzzing session in the AFL output folder `afl/transaction`
    ```
    cargo afl whatsup afl/transaction
    ```
  - reproduce some crash discovered by `afl` using `afl`
    ```
    cat afl/transaction/0_fast/queue/id:000001,time:0,execs:0,orig:system_001.raw | ./target-afl/release/transaction
    ```

* simple-fuzzer
  - Reproduce discovered crash
    ```
    ./fuzz.sh simple run afl/transaction/0_fast/crashes/id:000168,sig:06,src:001128+000312,time:260091,execs:21509,op:splice,rep:8
    ```
    or
    ```
    RUST_BACKTRACE=1 ./fuzz.sh simple run transaction afl/transaction/0_fast/crashes/id:000168,sig:06,src:001128+000312,time:260091,execs:21509,op:splice,rep:8
    ```

# Future considerations
- Implement more smart mutations in 'transaction' fuzz test
- Add more fuzz tests
- any ideas?
