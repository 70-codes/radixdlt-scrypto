# Introduction

This package implements fuzz tests for Radix Engine.
Currently it uses 3 fuzzing engines:
* [AFLplusplus](https://aflplus.plus/)
  It is wrapped by crate: [cargo-afl](https://docs.rs/afl/0.12.14/afl)
* simple-fuzzer
  This is a very simple fuzzer, which is especially useful when developing new fuzz tests.
  It allows to:
  - quickly rebuild a test and perform some simple checks (building AFL takes ages).
  - reproduce a crash (or other problematic case) using provided input file,
    (which might be generated by AFL)

# AFL
* Similarly to `libfuzzer` it sets `fuzzing` flag by default.
  Thus `cargo afl` shall be built and installed using below command
  ```
  cargo install afl --features no_cfg_fuzzing
  ```
* It requires some input data to be provided.

## Installation
One can use convenience script [install_afl.sh](./install_afl.sh) to install `cargo-afl` with the change mentioned above.

## Machine setup
Before starting to fuzz AFL checks machine configuration and requests to adjust some settings if required.
* Linux
  - do not send core dump notifications to external utilities.
    This is to notify fuzzer immediately about the crash, so it does not misinterpret crash as timeout.
    `sudo bash -c "echo core > /proc/sys/kernel/core_pattern"`

    Alternatively it is possible to use env `AFL_I_DONT_CARE_ABOUT_MISSING_CRASHES=1`
  - disable CPU frequency scaling to provide best performance
    `sudo bash -c "cd /sys/devices/system/cpu ; echo performance | tee cpu*/cpufreq/scaling_governor >/dev/null"`

    Alternatively it is possible to use env `AFL_SKIP_CPUFREQ=1`

* MacOS
  If you see an error message like `shmget() failed` above, try running the following command:
  ```
  sudo /Users/<username>/.local/share/afl.rs/rustc-1.67.1-d5a82bb/afl.rs-0.12.14/afl/bin/afl-system-config
  ```

# Input data
Sample input data shall be placed in `fuzz_input` folder in dedicated subfolder.
`AFL` is able to use the data in the same format.

In order to minimize the test corpus, the data might be prior processed.
Processing method is specific for fuzzing engine.

One can use following command to generate input data (`cargo afl cmin|tmin` are used here)
`./fuzz.sh generate-input [raw|unique|minimize]`
Check `./fuzz.sh help` for more details

# Fuzz tests
Available fuzz tests:
* transaction - Fuzzes transaction manifests and tries to execute it

# Usage

Helper script [fuzz.sh](./fuzz.sh) to unify fuzzing experience accross the fuzzing engines ;)

`./fuzz.sh [FUZZER/COMMAND] [SUBCOMMAND] [COMMAND-ARGS]`

Currently it allows to build and run fuzz tests using some default configuration.
Check: `./fuzz.sh help` for more details.

For more sophisticated use cases `cargo fuzz` or `cargo afl` shall be used directly.
Check:
`cargo +nightly fuzz --help`
or
`cargo afl --help`

## Examples
* Generate input
  - Generate input
    ```
    ./fuzz.sh generate-input raw|unique|minimize
    ```
  - Generate unique input
* AFL
  - Run 2 AFL sessions (`main` and `slave`) and let it automatically resume if the same session was already running
    (each command in separate console)
    ```
    AFL_AUTORESUME=1 cargo afl fuzz -i fuzz_input/transaction -o afl/transaction -M main -T transaction  target-afl/release/transaction
    ```
    ```
    AFL_AUTORESUME=1 cargo afl fuzz -i fuzz_input/transaction -o afl/transaction -S slave -T transaction  target-afl/release/transaction
    ```
  - Check status of the AFL fuzzing session in the AFL output folder `afl/transaction`
    ```
    cargo afl whatsup afl/transaction
    ```
  - reproduce some crash discovered by `afl` using `afl`
    ```
    cat afl/transaction/0_fast/queue/id:000001,time:0,execs:0,orig:system_001.raw | ./target-afl/release/transaction
    ```

* simple-fuzzer
  - Reproduce discovered crash
    ```
    ./fuzz.sh simple run afl/transaction/0_fast/crashes/id:000168,sig:06,src:001128+000312,time:260091,execs:21509,op:splice,rep:8
    ```
    or
    ```
    RUST_BACKTRACE=1 ./fuzz.sh simple run transaction afl/transaction/0_fast/crashes/id:000168,sig:06,src:001128+000312,time:260091,execs:21509,op:splice,rep:8
    ```

# Future considerations
- Implement more smart mutations in 'transaction' fuzz test
- Add more fuzz tests
- any ideas?
