use crate::errors::*;
use crate::kernel::kernel_api::KernelSubstateApi;
use crate::types::*;
use radix_engine_interface::api::substate_lock_api::LockFlags;
use radix_engine_interface::schema::KeyValueStoreSchema;
use crate::system::system_callback::SystemLockData;

#[derive(Debug, Clone, PartialEq, Eq, ScryptoSbor)]
pub enum TypeInfoSubstate {
    Object(ObjectInfo),
    KeyValueStore(KeyValueStoreSchema),
    Index,       // TODO: Add schema
    SortedIndex, // TODO: Add schema
}

impl TypeInfoSubstate {
    pub fn parent(&self) -> Option<GlobalAddress> {
        match self {
            TypeInfoSubstate::Object(x) => x.blueprint_parent.clone(),
            TypeInfoSubstate::KeyValueStore(_)
            | TypeInfoSubstate::Index
            | TypeInfoSubstate::SortedIndex => None,
        }
    }
}

pub struct TypeInfoBlueprint;

impl TypeInfoBlueprint {
    pub(crate) fn get_type<Y>(
        receiver: &NodeId,
        api: &mut Y,
    ) -> Result<TypeInfoSubstate, RuntimeError>
    where
        Y: KernelSubstateApi<SystemLockData>,
    {
        let handle = api.kernel_lock_substate(
            receiver,
            SysModuleId::TypeInfo.into(),
            &TypeInfoOffset::TypeInfo.into(),
            LockFlags::read_only(),
            SystemLockData::default(),
        )?;
        let info: TypeInfoSubstate = api.kernel_read_substate(handle)?.as_typed().unwrap();
        api.kernel_drop_lock(handle)?;
        Ok(info)
    }
}
